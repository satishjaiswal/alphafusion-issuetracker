{% extends "base.html" %}

{% block title %}Backlog{% endblock %}

{% block extra_head %}
<style>
/* Duplicate grouping styles */
.btn-expand-toggle {
    background: transparent;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm, 4px);
}

.btn-expand-toggle:hover {
    background: var(--bg-hover);
    color: var(--accent-primary);
}

.btn-expand-toggle .expand-icon {
    transition: transform 0.2s ease;
    width: 16px;
    height: 16px;
}

.btn-expand-toggle.expanded .expand-icon {
    transform: rotate(180deg);
}

.issue-row-primary.has-duplicates {
    background: var(--bg-card) !important;
}

.issue-row-primary.has-duplicates:hover {
    background: var(--bg-hover) !important;
}

.issue-row-duplicate {
    background: var(--bg-panel) !important;
    opacity: 0.9;
}

.issue-row-duplicate:hover {
    background: var(--bg-hover) !important;
    opacity: 1;
}

.issue-row-duplicate td:first-child {
    padding-left: 2rem;
    position: relative;
}

.issue-row-duplicate td:first-child::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 60%;
    background: var(--border);
    opacity: 0.5;
}

/* Category badges */
.badge-category-feature-request {
    background-color: var(--accent-primary, #3b82f6) !important;
    color: white !important;
}

.badge-category-suggestions {
    background-color: var(--accent-positive, #22c55e) !important;
    color: white !important;
}

.badge-category-improvement {
    background-color: var(--accent-warning, #f59e0b) !important;
    color: #000 !important;
}

.badge-category-must-have {
    background-color: var(--accent-primary, #3b82f6) !important;
    color: white !important;
}

.badge-category-critical {
    background-color: var(--accent-negative, #ef4444) !important;
    color: white !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Backlog</h1>
                <p class="text-muted mb-0">Feature requests, suggestions, and improvements</p>
            </div>
            <a href="{{ url_for('create_backlog') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Backlog Item
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('backlog_list') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Category</label>
                            <select name="category" class="form-select">
                                <option value="">All</option>
                                <option value="feature-request" {% if filters.get('category') == 'feature-request' %}selected{% endif %}>Feature Request</option>
                                <option value="suggestions" {% if filters.get('category') == 'suggestions' %}selected{% endif %}>Suggestions</option>
                                <option value="improvement" {% if filters.get('category') == 'improvement' %}selected{% endif %}>Improvement</option>
                                <option value="must-have" {% if filters.get('category') == 'must-have' %}selected{% endif %}>Must Have</option>
                                <option value="critical" {% if filters.get('category') == 'critical' %}selected{% endif %}>Critical</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary w-100">Filter</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if grouped_backlog %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Reporter</th>
                                <th>Assignee</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in grouped_backlog %}
                            {% set group_index = loop.index0 %}
                            {# Primary row - always visible #}
                            <tr class="issue-row-primary {% if group.is_group %}has-duplicates{% endif %}" data-group-id="group-{{ group_index }}">
                                <td>
                                    {% if group.is_group %}
                                    <button class="btn-expand-toggle" type="button" data-group-id="group-{{ group_index }}" aria-label="Toggle duplicates">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="expand-icon">
                                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('backlog_detail', backlog_id=group.primary.id) }}">{{ group.primary.id[:8] }}</a>
                                    {% if group.is_group %}
                                    <span class="badge bg-secondary ms-2" title="{{ group.count }} duplicate items">{{ group.count }}</span>
                                    {% endif %}
                                </td>
                                <td><a href="{{ url_for('backlog_detail', backlog_id=group.primary.id) }}">{{ group.primary.title }}</a></td>
                                <td>
                                    <span class="badge badge-category-{{ group.primary.category.value }}">
                                        {{ group.primary.category.value.replace('-', ' ').title() }}
                                    </span>
                                </td>
                                <td>{{ users.get(group.primary.reporter_id, {}).display_name or group.primary.reporter_id if users.get(group.primary.reporter_id) else group.primary.reporter_id }}</td>
                                <td>{{ users.get(group.primary.assignee_id, {}).display_name or group.primary.assignee_id if group.primary.assignee_id and users.get(group.primary.assignee_id) else (group.primary.assignee_id or '-') }}</td>
                                <td>{{ group.primary.created_at.strftime('%Y-%m-%d %H:%M') if group.primary.created_at else '-' }}</td>
                            </tr>
                            {# Duplicate rows - hidden by default #}
                            {% if group.is_group %}
                            {% for duplicate in group.duplicates %}
                            <tr class="issue-row-duplicate duplicate-row" data-group-id="group-{{ group_index }}" style="display: none;">
                                <td></td>
                                <td><a href="{{ url_for('backlog_detail', backlog_id=duplicate.id) }}">{{ duplicate.id[:8] }}</a></td>
                                <td><a href="{{ url_for('backlog_detail', backlog_id=duplicate.id) }}">{{ duplicate.title }}</a></td>
                                <td>
                                    <span class="badge badge-category-{{ duplicate.category.value }}">
                                        {{ duplicate.category.value.replace('-', ' ').title() }}
                                    </span>
                                </td>
                                <td>{{ users.get(duplicate.reporter_id, {}).display_name or duplicate.reporter_id if users.get(duplicate.reporter_id) else duplicate.reporter_id }}</td>
                                <td>{{ users.get(duplicate.assignee_id, {}).display_name or duplicate.assignee_id if duplicate.assignee_id and users.get(duplicate.assignee_id) else (duplicate.assignee_id or '-') }}</td>
                                <td>{{ duplicate.created_at.strftime('%Y-%m-%d %H:%M') if duplicate.created_at else '-' }}</td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“‹</div>
                    <div class="empty-state-title">No backlog items found</div>
                    <div class="empty-state-description">Get started by creating your first backlog item.</div>
                    <a href="{{ url_for('create_backlog') }}" class="btn btn-primary mt-3">Create Backlog Item</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle expand/collapse toggle for duplicate backlog items
    const expandButtons = document.querySelectorAll('.btn-expand-toggle');
    
    expandButtons.forEach(button => {
        button.addEventListener('click', function() {
            const groupId = this.getAttribute('data-group-id');
            const duplicateRows = document.querySelectorAll(`.duplicate-row[data-group-id="${groupId}"]`);
            const icon = this.querySelector('.expand-icon');
            const isExpanded = this.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                duplicateRows.forEach(row => {
                    row.style.display = 'none';
                });
                this.classList.remove('expanded');
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Expand
                duplicateRows.forEach(row => {
                    row.style.display = '';
                });
                this.classList.add('expanded');
                icon.style.transform = 'rotate(180deg)';
            }
        });
    });
});
</script>
{% endblock %}

