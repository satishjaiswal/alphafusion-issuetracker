{% extends "base.html" %}

{% block title %}Issues{% endblock %}

{% block extra_head %}
<style>
/* Duplicate grouping styles */
.btn-expand-toggle {
    background: transparent;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm, 4px);
}

.btn-expand-toggle:hover {
    background: var(--bg-hover);
    color: var(--accent-primary);
}

.btn-expand-toggle .expand-icon {
    transition: transform 0.2s ease;
    width: 16px;
    height: 16px;
}

.btn-expand-toggle.expanded .expand-icon {
    transform: rotate(180deg);
}

.issue-row-primary.has-duplicates {
    background: var(--bg-card) !important;
}

.issue-row-primary.has-duplicates:hover {
    background: var(--bg-hover) !important;
}

.issue-row-duplicate {
    background: var(--bg-panel) !important;
    opacity: 0.9;
}

.issue-row-duplicate:hover {
    background: var(--bg-hover) !important;
    opacity: 1;
}

.issue-row-duplicate td:first-child {
    padding-left: 2rem;
    position: relative;
}

.issue-row-duplicate td:first-child::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    width: 2px;
    height: 60%;
    background: var(--border);
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Issues</h1>
                {% if source == 'recent' %}
                <p class="text-muted mb-0">Recent issues (from Firebase)</p>
                {% else %}
                <p class="text-muted mb-0">All issues (from Firebase)</p>
                {% endif %}
            </div>
            <a href="{{ url_for('create_issue') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Create Issue
            </a>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Filters</h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('issues_recent' if source == 'recent' else 'issues_all') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="">All</option>
                                <option value="open" {% if filters.get('status') == 'open' %}selected{% endif %}>Open</option>
                                <option value="in-progress" {% if filters.get('status') == 'in-progress' %}selected{% endif %}>In Progress</option>
                                <option value="resolved" {% if filters.get('status') == 'resolved' %}selected{% endif %}>Resolved</option>
                                <option value="closed" {% if filters.get('status') == 'closed' %}selected{% endif %}>Closed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Priority</label>
                            <select name="priority" class="form-select">
                                <option value="">All</option>
                                <option value="low" {% if filters.get('priority') == 'low' %}selected{% endif %}>Low</option>
                                <option value="medium" {% if filters.get('priority') == 'medium' %}selected{% endif %}>Medium</option>
                                <option value="high" {% if filters.get('priority') == 'high' %}selected{% endif %}>High</option>
                                <option value="critical" {% if filters.get('priority') == 'critical' %}selected{% endif %}>Critical</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Type</label>
                            <select name="type" class="form-select">
                                <option value="">All</option>
                                <option value="bug" {% if filters.get('type') == 'bug' %}selected{% endif %}>Bug</option>
                                <option value="feature" {% if filters.get('type') == 'feature' %}selected{% endif %}>Feature</option>
                                <option value="task" {% if filters.get('type') == 'task' %}selected{% endif %}>Task</option>
                                <option value="enhancement" {% if filters.get('type') == 'enhancement' %}selected{% endif %}>Enhancement</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary w-100">Filter</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if grouped_issues %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Priority</th>
                                <th>Status</th>
                                <th>Reporter</th>
                                <th>Assignee</th>
                                <th>Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in grouped_issues %}
                            {% set group_index = loop.index0 %}
                            {# Primary row - always visible #}
                            <tr class="issue-row-primary {% if group.is_group %}has-duplicates{% endif %}" data-group-id="group-{{ group_index }}">
                                <td>
                                    {% if group.is_group %}
                                    <button class="btn-expand-toggle" type="button" data-group-id="group-{{ group_index }}" aria-label="Toggle duplicates">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="expand-icon">
                                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('issue_detail', issue_id=group.primary.id) }}">{{ group.primary.id[:8] }}</a>
                                    {% if group.is_group %}
                                    <span class="badge bg-secondary ms-2" title="{{ group.count }} duplicate issues">{{ group.count }}</span>
                                    {% endif %}
                                </td>
                                <td><a href="{{ url_for('issue_detail', issue_id=group.primary.id) }}">{{ group.primary.title }}</a></td>
                                <td><span class="badge bg-secondary">{{ group.primary.type.value }}</span></td>
                                <td><span class="badge badge-priority-{{ group.primary.priority.value }}">{{ group.primary.priority.value }}</span></td>
                                <td><span class="badge badge-status-{{ group.primary.status.value }}">{{ group.primary.status.value }}</span></td>
                                <td>{{ users.get(group.primary.reporter_id, {}).display_name or group.primary.reporter_id if users.get(group.primary.reporter_id) else group.primary.reporter_id }}</td>
                                <td>{{ users.get(group.primary.assignee_id, {}).display_name or group.primary.assignee_id if group.primary.assignee_id and users.get(group.primary.assignee_id) else (group.primary.assignee_id or '-') }}</td>
                                <td>{{ group.primary.created_at.strftime('%Y-%m-%d %H:%M') if group.primary.created_at else '-' }}</td>
                            </tr>
                            {# Duplicate rows - hidden by default #}
                            {% if group.is_group %}
                            {% for duplicate in group.duplicates %}
                            <tr class="issue-row-duplicate duplicate-row" data-group-id="group-{{ group_index }}" style="display: none;">
                                <td></td>
                                <td><a href="{{ url_for('issue_detail', issue_id=duplicate.id) }}">{{ duplicate.id[:8] }}</a></td>
                                <td><a href="{{ url_for('issue_detail', issue_id=duplicate.id) }}">{{ duplicate.title }}</a></td>
                                <td><span class="badge bg-secondary">{{ duplicate.type.value }}</span></td>
                                <td><span class="badge badge-priority-{{ duplicate.priority.value }}">{{ duplicate.priority.value }}</span></td>
                                <td><span class="badge badge-status-{{ duplicate.status.value }}">{{ duplicate.status.value }}</span></td>
                                <td>{{ users.get(duplicate.reporter_id, {}).display_name or duplicate.reporter_id if users.get(duplicate.reporter_id) else duplicate.reporter_id }}</td>
                                <td>{{ users.get(duplicate.assignee_id, {}).display_name or duplicate.assignee_id if duplicate.assignee_id and users.get(duplicate.assignee_id) else (duplicate.assignee_id or '-') }}</td>
                                <td>{{ duplicate.created_at.strftime('%Y-%m-%d %H:%M') if duplicate.created_at else '-' }}</td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No issues found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle expand/collapse toggle for duplicate issues
    const expandButtons = document.querySelectorAll('.btn-expand-toggle');
    
    expandButtons.forEach(button => {
        button.addEventListener('click', function() {
            const groupId = this.getAttribute('data-group-id');
            const duplicateRows = document.querySelectorAll(`.duplicate-row[data-group-id="${groupId}"]`);
            const icon = this.querySelector('.expand-icon');
            const isExpanded = this.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                duplicateRows.forEach(row => {
                    row.style.display = 'none';
                });
                this.classList.remove('expanded');
                icon.style.transform = 'rotate(0deg)';
            } else {
                // Expand
                duplicateRows.forEach(row => {
                    row.style.display = '';
                });
                this.classList.add('expanded');
                icon.style.transform = 'rotate(180deg)';
            }
        });
    });
});
</script>
{% endblock %}

